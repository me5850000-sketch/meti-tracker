<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>METI Tasks Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --primary:#1E6C93; --primary-dark:#155270; --primary-light:#2a85b5;
  --primary-xlight:#e8f4fb; --accent:#0fa3d4;
  --surface:#fff; --bg:#f0f4f7; --border:#ccdde8; --border-focus:#1E6C93;
  --text:#1a2733; --text-secondary:#4a6375; --text-muted:#7a96a8;
  --error:#c0392b; --error-bg:#fdf0ee;
  --success:#1a8a5a; --success-bg:#edf7f3;
  --input-bg:#f7fbfd;
  --shadow-sm:0 1px 3px rgba(30,108,147,.08);
  --shadow-md:0 4px 16px rgba(30,108,147,.12);
  --shadow-lg:0 8px 32px rgba(30,108,147,.16);
  --radius:8px; --radius-lg:12px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:radial-gradient(circle at 20% 20%,rgba(30,108,147,.04) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(15,163,212,.04) 0%,transparent 50%);pointer-events:none;z-index:0}
.page{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;min-height:100vh}
.topbar{width:100%;background:var(--primary-dark);padding:0 40px;height:52px;display:flex;align-items:center;justify-content:space-between}
.topbar-brand{display:flex;align-items:center;gap:12px}
.topbar-logo-box{width:32px;height:32px;background:rgba(255,255,255,.15);border-radius:6px;display:flex;align-items:center;justify-content:center}
.topbar-logo-box svg{width:18px;height:18px}
.topbar-company{font-family:'Plus Jakarta Sans',sans-serif;font-size:.75rem;font-weight:600;color:rgba(255,255,255,.7);letter-spacing:2px;text-transform:uppercase}
.topbar-time{font-size:.78rem;color:rgba(255,255,255,.55);font-weight:500;letter-spacing:.5px}
header.main-header{width:100%;background:var(--primary);padding:28px 48px 32px;display:flex;align-items:flex-end;gap:24px;box-shadow:0 2px 12px rgba(30,108,147,.25)}
.header-meti{font-family:'Plus Jakarta Sans',sans-serif;font-size:3rem;font-weight:800;color:#fff;letter-spacing:-1px;line-height:1}
.header-divider{width:1px;height:44px;background:rgba(255,255,255,.25);flex-shrink:0;margin-bottom:2px}
.header-info{display:flex;flex-direction:column;gap:4px;margin-bottom:3px}
.header-full-name{font-family:'Plus Jakarta Sans',sans-serif;font-size:.82rem;font-weight:600;color:rgba(255,255,255,.75);letter-spacing:1.5px;text-transform:uppercase}
.header-dept{font-size:.75rem;color:rgba(255,255,255,.5);font-weight:400;letter-spacing:.5px}
.header-badge{margin-left:auto;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:6px;padding:8px 18px;text-align:center;margin-bottom:2px}
.header-badge-title{font-family:'Plus Jakarta Sans',sans-serif;font-size:1.05rem;font-weight:700;color:#fff;letter-spacing:.5px;display:block}
.progress-bar-track{width:100%;height:4px;background:rgba(30,108,147,.12)}
.progress-bar-fill{height:100%;width:0%;background:var(--accent);transition:width .4s ease}
.content{width:100%;max-width:1480px;padding:36px 32px 24px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-md);overflow:hidden;animation:slideUp .4s ease both}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.card-section{border-bottom:1px solid #edf2f6;padding:36px 48px}
.card-section:last-child{border-bottom:none}
.section-header{display:flex;align-items:center;gap:10px;margin-bottom:22px}
.section-icon{width:30px;height:30px;background:var(--primary-xlight);border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.section-icon svg{width:15px;height:15px;color:var(--primary)}
.section-title{font-family:'Plus Jakarta Sans',sans-serif;font-size:.82rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--primary)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:22px;margin-bottom:22px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:22px;margin-bottom:22px}
.full{margin-bottom:22px}
.field label{display:block;font-size:1.15rem;font-weight:600;color:var(--text-secondary);margin-bottom:8px;letter-spacing:.2px}
.field label .req{color:var(--error);margin-left:2px}
.field label .sub{display:block;font-size:.7rem;font-weight:400;color:var(--text-muted);margin-top:2px}
input,select,textarea{width:100%;background:var(--input-bg);border:1.5px solid var(--border);border-radius:var(--radius);padding:12px 16px;color:var(--text);font-family:'Inter',sans-serif;font-size:1.05rem;outline:none;transition:border-color .18s,box-shadow .18s,background .18s;appearance:none;-webkit-appearance:none}
input::placeholder,textarea::placeholder{color:var(--text-muted)}
input:focus,select:focus,textarea:focus{border-color:var(--border-focus);box-shadow:0 0 0 3px rgba(30,108,147,.1);background:#fff}
input[readonly]{background:#f2f6f9;color:var(--text-muted);cursor:default}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none}
input[type=number]{-moz-appearance:textfield}
.sdw{position:relative}
.sdb{width:100%;background:var(--input-bg);border:1.5px solid var(--border);border-radius:var(--radius);padding:12px 34px 12px 16px;color:var(--text);font-family:'Inter',sans-serif;font-size:1.05rem;text-align:left;cursor:pointer;outline:none;transition:border-color .18s,box-shadow .18s,background .18s;display:flex;align-items:center;position:relative;min-height:48px}
.sdb input.sd-input{flex:1;border:none;background:transparent;padding:0;font-size:1.05rem;color:var(--text);outline:none;cursor:text;font-family:'Inter',sans-serif;min-width:0}
.sdb input.sd-input::placeholder{color:var(--text-muted)}
.sdb .sd-arrow{position:absolute;right:13px;top:50%;transform:translateY(-50%);color:var(--primary);pointer-events:none;font-size:.8rem;transition:transform .2s}
.sdb.open{border-color:var(--border-focus);box-shadow:0 0 0 3px rgba(30,108,147,.1);background:#fff}
.sdb.open .sd-arrow{transform:translateY(-50%) rotate(180deg)}
.sd-display{flex:1;min-width:0;font-size:1.05rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:none;cursor:pointer}
.sdl{position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1.5px solid var(--border-focus);border-radius:var(--radius);z-index:300;list-style:none;box-shadow:var(--shadow-lg);display:none;overflow:hidden;max-height:280px;overflow-y:auto}
.sdl.open{display:block}
.sdl li{padding:11px 14px;cursor:pointer;font-size:.95rem;color:var(--text);border-bottom:1px solid #f0f4f7;transition:background .15s;line-height:1.5}
.sdl li:last-child{border-bottom:none}
.sdl li:hover,.sdl li.sd-hover{background:var(--primary-xlight);color:var(--primary-dark)}
.sdl li.sel{background:var(--primary-xlight);color:var(--primary);font-weight:600}
.sdl li.sd-empty{color:var(--text-muted);font-style:italic;cursor:default;font-size:.88rem}
.sdl li.sd-empty:hover{background:transparent;color:var(--text-muted)}
.hl{color:#e07b00;font-weight:700;background:rgba(224,123,0,.1);border:1px solid rgba(224,123,0,.3);border-radius:5px;padding:1px 7px;margin:0 1px;display:inline-block;letter-spacing:.2px}
.acw{position:relative}
.acl{position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1.5px solid var(--border-focus);border-radius:var(--radius);max-height:220px;overflow-y:auto;z-index:500;box-shadow:var(--shadow-lg);display:none}
.acl.open{display:block}
.acl li{padding:10px 14px;cursor:pointer;font-size:1.05rem;color:var(--text);list-style:none;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #f0f4f7;transition:background .15s}
.acl li:last-child{border-bottom:none}
.acl li:hover,.acl li.ac-hover{background:var(--primary-xlight)}
.delbtn{font-size:.7rem;color:transparent;padding:2px 8px;border-radius:4px;border:none;background:none;cursor:pointer;transition:color .15s}
.acl li:hover .delbtn,.acl li.ac-hover .delbtn{color:var(--text-muted)}
.delbtn:hover{color:var(--error)!important}
.qtc-hint{font-size:.72rem;color:var(--text-muted);margin-bottom:10px;font-style:italic}
.qtc-shift-msg{font-size:.82rem;color:var(--primary);padding:12px 14px;background:var(--primary-xlight);border-radius:var(--radius);border:1px solid var(--border);display:none}
.qtc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:8px;max-height:280px;overflow-y:auto;padding:2px}
.qtc-grid::-webkit-scrollbar{width:5px}
.qtc-grid::-webkit-scrollbar-track{background:#f0f4f7;border-radius:4px}
.qtc-grid::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.qtc-card{background:var(--input-bg);border:1.5px solid var(--border);border-radius:var(--radius);padding:10px 12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:10px;user-select:none}
.qtc-card:hover{border-color:var(--primary-light);background:var(--primary-xlight)}
.qtc-card.selected{border-color:var(--success);background:var(--success-bg);box-shadow:0 0 0 3px rgba(26,138,90,.1)}
.qtc-card .qtc-check{width:18px;height:18px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s;font-size:.7rem}
.qtc-card.selected .qtc-check{border-color:var(--success);background:var(--success);color:#fff}
.qtc-card .qtc-name{font-size:.83rem;font-weight:600;color:var(--text);line-height:1.3}
.qtc-card .qtc-role{font-size:.72rem;color:var(--primary);margin-top:1px;font-weight:500}
.qtc-card.selected .qtc-name{color:var(--success)}
.qtc-selected-display{margin-top:10px;min-height:32px;display:flex;flex-wrap:wrap;gap:6px}
.qtc-tag{background:var(--success-bg);border:1px solid rgba(26,138,90,.35);color:var(--success);border-radius:20px;padding:4px 12px;font-size:.75rem;font-weight:600;display:flex;align-items:center;gap:6px}
.qtc-tag button{background:none;border:none;color:var(--success);cursor:pointer;font-size:.8rem;padding:0;line-height:1;opacity:.7}
.qtc-tag button:hover{opacity:1}
.frames-merged{display:flex;align-items:center;gap:10px}
.frames-merged input{flex:1}
.frames-sep{color:var(--text-muted);font-size:1.1rem;font-weight:700;flex-shrink:0}
.atog{display:flex;gap:12px;margin-top:4px}
.abtn{flex:1;padding:13px 10px;background:var(--input-bg);border:1.5px solid var(--border);border-radius:var(--radius);color:var(--text-muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:.92rem;font-weight:700;letter-spacing:.3px;cursor:pointer;transition:all .2s}
.abtn:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-xlight)}
.abtn.asubmit{background:var(--success-bg);border-color:var(--success);color:var(--success)}
.abtn.askip{background:var(--primary-xlight);border-color:var(--primary);color:var(--primary)}
.branch{border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:18px;background:#fafcfe;animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.subbtn{width:100%;padding:14px;background:var(--primary);border:none;border-radius:var(--radius);color:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-size:.95rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:background .2s,transform .1s,box-shadow .2s;box-shadow:0 3px 12px rgba(30,108,147,.3)}
.subbtn:hover{background:var(--primary-light);box-shadow:0 4px 20px rgba(30,108,147,.4)}
.subbtn:active{transform:scale(.99)}
.subbtn:disabled{opacity:.6;cursor:not-allowed}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(16px);padding:12px 28px;border-radius:var(--radius);font-size:1.05rem;font-weight:600;opacity:0;pointer-events:none;transition:all .3s;z-index:999;box-shadow:var(--shadow-lg)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.ok{background:var(--success-bg);border:1px solid rgba(26,138,90,.4);color:var(--success)}
.toast.err{background:var(--error-bg);border:1px solid rgba(192,57,43,.3);color:var(--error)}
.err-field{border-color:var(--error)!important;box-shadow:0 0 0 3px rgba(192,57,43,.1)!important;animation:shake .3s ease}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-3px)}40%,80%{transform:translateX(3px)}}
.task-id-wrap{position:relative}
.task-id-wrap input{padding-right:38px}
#idIcon{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:.8rem;opacity:.4}
#linkHint{color:var(--text-muted)}
.form-footer{background:#f7fbfd;border-top:1px solid var(--border);padding:20px 32px}
.storage-panel{width:100%;max-width:1480px;margin:16px 0 40px;border:1px solid var(--border);border-radius:var(--radius-lg);background:var(--surface);box-shadow:var(--shadow-sm);overflow:hidden}
.storage-toggle{width:100%;padding:14px 20px;background:#f7fbfd;border:none;cursor:pointer;display:flex;align-items:center;gap:10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.85rem;font-weight:700;color:var(--primary);letter-spacing:.5px;transition:background .15s}
.storage-toggle:hover{background:var(--primary-xlight)}
.storage-arrow{margin-left:auto;font-size:.7rem;transition:transform .2s;display:inline-block}
.storage-arrow.open{transform:rotate(180deg)}
.storage-body{padding:20px 24px;display:flex;flex-direction:column;gap:20px;border-top:1px solid var(--border)}
.storage-group{display:flex;flex-direction:column;gap:10px}
.storage-group-header{display:flex;align-items:center;justify-content:space-between;padding-bottom:8px;border-bottom:1px solid #edf2f6}
.storage-group-title{font-size:.78rem;font-weight:700;color:var(--text-secondary);letter-spacing:.5px}
.storage-clear-all{font-size:.72rem;font-weight:600;color:var(--error);background:var(--error-bg);border:1px solid rgba(192,57,43,.2);border-radius:5px;padding:3px 10px;cursor:pointer;transition:all .15s}
.storage-clear-all:hover{background:rgba(192,57,43,.15)}
.storage-list{display:flex;flex-wrap:wrap;gap:7px;min-height:32px}
.storage-item{display:flex;align-items:center;gap:6px;background:var(--input-bg);border:1.5px solid var(--border);border-radius:20px;padding:5px 12px;font-size:.82rem;font-weight:500;color:var(--text);transition:border-color .15s}
.storage-item:hover{border-color:var(--error)}
.storage-item-del{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:.8rem;padding:0;line-height:1;transition:color .15s}
.storage-item-del:hover{color:var(--error)}
.storage-empty{font-size:.78rem;color:var(--text-muted);font-style:italic;padding:4px 0}
@media(max-width:640px){
  .g2,.g3{grid-template-columns:1fr}
  .atog{flex-direction:column}
  .card-section{padding:22px 18px}
  .header-badge{display:none}
  .qtc-grid{grid-template-columns:1fr 1fr}
  .content{padding:24px 16px 16px}
  .storage-panel{margin:12px 0 32px}
}
</style>
</head>
<body>
<div class="page">
  <div class="topbar">
    <div class="topbar-brand">
      <div class="topbar-logo-box">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
        </svg>
      </div>
      <span class="topbar-company">Micro Engineering Tech Inc.</span>
    </div>
    <span class="topbar-time" id="topTime">Loading...</span>
  </div>

  <header class="main-header">
    <div class="header-meti">METI</div>
    <div class="header-divider"></div>
    <div class="header-info">
      <div class="header-full-name">Micro Engineering</div>
      <div class="header-dept">Labeling Operations &middot; Internal System</div>
    </div>
    <div class="header-badge">
      <span class="header-badge-title">Tasks Tracker</span>
    </div>
  </header>

  <div class="progress-bar-track"><div class="progress-bar-fill" id="progressBar"></div></div>

  <div class="content">
    <div class="card">
      <form id="F" autocomplete="off">

        <div class="card-section">
          <div class="section-header">
            <div class="section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <span class="section-title">Session Information</span>
          </div>

          <div class="full field">
            <label>Timestamp</label>
            <input type="text" id="ts" readonly>
          </div>

          <div class="g3">
            <div class="field">
              <label>Shift <span class="req">*</span></label>
              <div class="sdw">
                <div class="sdb" id="shiftBtn" tabindex="0">
                  <input class="sd-input" id="shiftInput" placeholder="Select Shift..." autocomplete="off" data-lpignore="true">
                  <span class="sd-arrow">&#9660;</span>
                </div>
                <ul class="sdl" id="shiftList">
                  <li data-v="Morning">Morning</li>
                  <li data-v="Night">Night</li>
                  <li data-v="Over Night">Over Night</li>
                  <li data-v="Morning 12 H">Morning 12 H</li>
                  <li data-v="Over Night 12 H">Over Night 12 H</li>
                </ul>
                <input type="hidden" id="shift">
              </div>
            </div>
            <div class="field">
              <label>Unit <span class="req">*</span></label>
              <div class="sdw">
                <div class="sdb" id="unitBtn" tabindex="0">
                  <input class="sd-input" id="unitInput" placeholder="Select Unit..." autocomplete="off" data-lpignore="true">
                  <span class="sd-arrow">&#9660;</span>
                </div>
                <ul class="sdl" id="unitList">
                  <li data-v="NC Room 102">NC Room 102</li>
                  <li data-v="NC Room 106">NC Room 106</li>
                  <li data-v="NC Room 108">NC Room 108</li>
                  <li data-v="2nd Floor">2nd Floor</li>
                  <li data-v="4th Floor">4th Floor</li>
                </ul>
                <input type="hidden" id="unit">
              </div>
            </div>
            <div class="field">
              <label>PC No. <span class="req">*</span></label>
              <input type="text" id="pcNo" placeholder="e.g. 7, 30 or QTC" required autocomplete="off">
            </div>
          </div>

          <div class="full field">
            <label>Labeler Name <span class="req">*</span></label>
            <div class="acw">
              <input type="text" id="labName" placeholder="Start typing a name..." required autocomplete="off" data-lpignore="true">
              <ul class="acl" id="acList"></ul>
            </div>
          </div>

          <div class="g2">
            <div class="field">
              <label>QTC Shift <span class="req">*</span></label>
              <div class="sdw">
                <div class="sdb" id="qtcShiftBtn" tabindex="0">
                  <input class="sd-input" id="qtcShiftInput" placeholder="Select QTC Shift..." autocomplete="off" data-lpignore="true">
                  <span class="sd-arrow">&#9660;</span>
                </div>
                <ul class="sdl" id="qtcShiftList">
                  <li data-v="Morning">Morning</li>
                  <li data-v="Night">Night</li>
                  <li data-v="Over Night">Over Night</li>
                </ul>
                <input type="hidden" id="qtcShiftSel">
              </div>
            </div>
            <div class="field">
              <label>Yubikey <span class="req">*</span></label>
              <div class="acw">
                <input type="text" id="yk" placeholder="e.g. 123456 or ME123456@meti.ai" required autocomplete="off" data-lpignore="true">
                <ul class="acl" id="ykAcList"></ul>
              </div>
              <div id="ykHint" style="font-size:.72rem;color:var(--text-muted);margin-top:5px;">6-digit code <span style="color:var(--border)">|</span> or email format: ME123456@meti.ai</div>
            </div>
          </div>

          <div class="full field">
            <label>QTC Name <span class="req">*</span></label>
            <div id="qtcShiftMsg" class="qtc-shift-msg">&#9432; Please select a QTC Shift first to view available names.</div>
            <div id="qtcPickerWrap" style="display:none">
              <input type="text" id="qtcSearch" placeholder="&#128269; Search by name..." autocomplete="off" style="margin-bottom:10px;background:#f7fbfd;">
              <div class="qtc-hint">Click on a name to select &mdash; scroll to see all</div>
              <div class="qtc-grid" id="qtcGrid"></div>
              <div class="qtc-selected-display" id="qtcSelectedDisplay"></div>
            </div>
            <input type="hidden" id="qtcName">
          </div>
        </div>

        <div class="card-section">
          <div class="section-header">
            <div class="section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            </div>
            <span class="section-title">Task Details</span>
          </div>

          <div class="g2">
            <div class="field">
              <label>Modality <span class="req">*</span></label>
              <div class="sdw">
                <div class="sdb" id="modalityBtn" tabindex="0">
                  <input class="sd-input" id="modalityInput" placeholder="Select Modality..." autocomplete="off" data-lpignore="true">
                  <span class="sd-arrow">&#9660;</span>
                </div>
                <ul class="sdl" id="modalityList">
                  <li data-v="Lane Line">Lane Line</li>
                  <li data-v="Lidar">Lidar</li>
                  <li data-v="Image">Image</li>
                  <li data-v="Relabeling">Relabeling</li>
                </ul>
                <input type="hidden" id="modality">
              </div>
            </div>
            <div class="field">
              <label>Queue Name <span class="req">*</span></label>
              <div class="sdw">
                <div class="sdb" id="queueBtn" tabindex="0">
                  <span class="sd-display" id="queueDisplay"></span>
                  <input class="sd-input" id="queueInput" placeholder="Select Queue..." autocomplete="off" data-lpignore="true">
                  <span class="sd-arrow">&#9660;</span>
                </div>
                <ul class="sdl" id="queueList">
                  <li data-v="sc3_full_scene_highway_mapless_filtered_3d_lanes">sc3_full_scene_highway_mapless_<span class="hl">filtered</span>_3d_lanes</li>
                  <li data-v="sc3_full_scene_highway_lanes_first_lidar_labeling">sc3_full_scene_highway_lanes_<span class="hl">first_lidar</span>_labeling</li>
                  <li data-v="sc3_full_scene_highway_lidar_only_labeling">sc3_full_scene_highway_<span class="hl">lidar_only</span>_labeling</li>
                </ul>
                <input type="hidden" id="qName">
              </div>
            </div>
          </div>

          <div class="full field">
            <label>Task Link <span class="req">*</span>
              <span class="sub" id="linkHint">Must start with: https://labeling.robot.car/#</span>
            </label>
            <input type="text" id="taskLink" placeholder="https://labeling.robot.car/#..." required autocomplete="off">
          </div>

          <div class="g2">
            <div class="field">
              <label>Task ID <span class="req">*</span></label>
              <div class="task-id-wrap">
                <input type="text" id="taskId" placeholder="Auto-filled" required>
                <span id="idIcon">&#8212;</span>
              </div>
              <div id="taskIdWarn" style="display:none;margin-top:6px;align-items:center;gap:6px;font-size:.75rem;color:#b45309;background:#fffbeb;border:1px solid #fcd34d;border-radius:6px;padding:6px 10px;">
                <span style="font-size:.9rem;font-weight:700;">&#9888;</span>
                <span>Heads up &mdash; this ID differs from the one in the link</span>
              </div>
            </div>
            <div class="field">
              <label>Pass <span class="req">*</span></label>
              <div class="sdw">
                <div class="sdb" id="passBtn" tabindex="0">
                  <input class="sd-input" id="passInput" placeholder="Auto-filled from link..." autocomplete="off" data-lpignore="true">
                  <span class="sd-arrow">&#9660;</span>
                </div>
                <ul class="sdl" id="passList">
                  <li data-v="FP">FP</li>
                  <li data-v="QA">QA</li>
                </ul>
                <input type="hidden" id="pass">
              </div>
            </div>
          </div>
        </div>

        <div class="card-section">
          <div class="section-header">
            <div class="section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
            </div>
            <span class="section-title">Task Action</span>
          </div>

          <div class="full field">
            <label>What would you like to do with this task? <span class="req">*</span></label>
            <div class="atog">
              <button type="button" class="abtn" id="btnSubmit">&#10004;&nbsp; Submit</button>
              <button type="button" class="abtn" id="btnSkip">&#9193;&nbsp; Skip</button>
            </div>
            <input type="hidden" id="action">
          </div>

          <div id="brSubmit" class="branch" style="display:none">
            <div class="field" style="margin-bottom:0">
              <label>How Many Objects? <span class="req">*</span></label>
              <input type="number" id="objCount" placeholder="Enter number of objects" min="0">
            </div>
          </div>

          <div id="brSkip" class="branch" style="display:none">
            <div class="field" style="margin-bottom:0">
              <label>Reason <span class="req">*</span></label>
              <div class="sdw">
                <div class="sdb" id="reasonBtn" tabindex="0">
                  <input class="sd-input" id="reasonInput" placeholder="Select an issue..." autocomplete="off" data-lpignore="true">
                  <span class="sd-arrow">&#9660;</span>
                </div>
                <ul class="sdl" id="reasonList">
                  <li data-v="Edge Case">Edge Case</li>
                  <li data-v="Not a freeway">Not a freeway</li>
                  <li data-v="Camera projection issue">Camera projection issue</li>
                  <li data-v="Lidar points shifting vertically">Lidar points shifting vertically</li>
                  <li data-v="Degraded lidar returns">Degraded lidar returns</li>
                  <li data-v="Tool Issue">Tool Issue</li>
                  <li data-v="Other">Other</li>
                </ul>
                <input type="hidden" id="reason">
              </div>
            </div>
            <div id="framesRow" style="display:none;margin-top:18px" class="field">
              <label>Issued Frames <span class="req">*</span><span class="sub">Format: 100&ndash;150</span></label>
              <div class="frames-merged">
                <input type="number" id="fromFrame" placeholder="From e.g. 100" min="0">
                <span class="frames-sep">&#8212;</span>
                <input type="number" id="toFrame" placeholder="To e.g. 150" min="0">
              </div>
            </div>
            <div id="notesRow" style="display:none;margin-top:18px" class="field">
              <label id="notesLabel">Notes <span class="req">*</span></label>
              <textarea id="notes" rows="3" placeholder="Write your notes here..." style="resize:vertical;line-height:1.6"></textarea>
            </div>
          </div>
        </div>

        <div class="form-footer" id="finalWrap" style="display:none">
          <button type="submit" class="subbtn" id="subBtn">&#9193;&nbsp; Skip Task</button>
        </div>

      </form>
    </div>

    <div class="storage-panel">
      <button type="button" class="storage-toggle" id="storageToggle">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:15px;height:15px;flex-shrink:0"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
        <span>Saved Data</span>
        <span class="storage-arrow" id="storageArrow">&#9660;</span>
      </button>
      <div class="storage-body" id="storageBody" style="display:none">
        <div class="storage-group">
          <div class="storage-group-header">
            <span class="storage-group-title">&#128100; Labeler Names</span>
            <button type="button" class="storage-clear-all" id="clearNamesBtn">Clear All</button>
          </div>
          <div id="storageNames" class="storage-list"></div>
        </div>
        <div class="storage-group">
          <div class="storage-group-header">
            <span class="storage-group-title">&#128273; Yubikeys</span>
            <button type="button" class="storage-clear-all" id="clearYKBtn">Clear All</button>
          </div>
          <div id="storageYK" class="storage-list"></div>
        </div>
        <div class="storage-group">
          <div class="storage-group-header">
            <span class="storage-group-title">&#128187; PC No.</span>
            <button type="button" class="storage-clear-all" id="clearPCBtn">Clear</button>
          </div>
          <div id="storagePC" class="storage-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
var SHEET_URL = "https://script.google.com/macros/s/AKfycbw1ykxEq-L76F-AUS8Dh7R4J9TkULcjzGqa4SzV2l_63j5AAxOQxbk8qehriD0amVXKbA/exec";
var NK = "meti_labeler_names";
var NK_YK = "meti_yk_history";
var NK_PC = "meti_pc_last";
var FRAME_R = ["Lidar points shifting vertically"];
var selectedQTC = null;
var linkTaskId = "";

var QTC_DATA = {
  "Morning": [
    {name:"Abdelrahman Refaat",role:"QT"},{name:"Hassan Mohamed",role:"QT"},
    {name:"Adel Ashraf",role:"QT"},{name:"Yousef Abass",role:"QT"},
    {name:"Ahmed Taha",role:"QT"},{name:"Bassant Sherif",role:"QT"},
    {name:"Amr Salah",role:""},{name:"Mazen Ehab",role:""},
    {name:"Hagar Fawzy",role:""},{name:"Roqia Wael",role:""},
    {name:"Eman Gamal",role:""},{name:"Kirollos Ibrahem",role:""},
    {name:"Rawan Elmahdy",role:""},{name:"Shimaa Nasser",role:""},
    {name:"Aya Mamdouh",role:""},{name:"Sara Atef",role:""},
    {name:"Nada Wagih",role:""},{name:"Nadien Mohey",role:""},
    {name:"Aya Yousry",role:""},{name:"Rahma Sayed",role:""},
    {name:"Hossam Hassan",role:""},{name:"Mira Samir",role:""},
    {name:"Asmaa Mohamed",role:""},{name:"Nesma Mustafa",role:""},
    {name:"Hagar Atef",role:""},{name:"Ahmed Adel",role:""},
    {name:"Asmaa Medhat",role:""},{name:"Moataz Ahmed",role:""},
    {name:"Wafaa Fathy",role:""},{name:"Omnia Mohamed",role:""},
    {name:"Eslam Ali",role:""},{name:"Asmaa Khaled",role:""},
    {name:"Donia El Said",role:""},{name:"Mayada Adel",role:""},
    {name:"Reem Samir",role:""},{name:"Ashiry",role:""},
    {name:"Abdelmonsef",role:"SV"},{name:"Yasmeen Nasser",role:"SV"},
    {name:"Mohamed Khaled",role:"SV"},{name:"Mohamed Abdel Azim",role:"SV"}
  ],
  "Night": [
    {name:"Hazem Nader",role:"QT"},{name:"Mohamed Sayed",role:"QT"},
    {name:"Abdelrahman Adel",role:"QT"},{name:"Mohamed Kamal",role:"QT"},
    {name:"Mahmoud Khaled",role:""},{name:"Ibrahim Mohamed Ibrahim",role:""},
    {name:"Kerolos Emil Shawky",role:""},{name:"Hussien Ali",role:""},
    {name:"Ahmed Nagy",role:""},{name:"Ali Suliman",role:""},
    {name:"Mostafa Helal",role:""},{name:"Osama Ashraf",role:""},
    {name:"Marwan Mohamed",role:""},{name:"Tony Emad",role:""},
    {name:"Hesham Hassan",role:""},{name:"Mahmoud Adel",role:""},
    {name:"Abdelrahman Omar",role:""},{name:"Abdelrahman Tarek Abdo",role:""},
    {name:"Yousef Mohamed Abdelfatah",role:""},{name:"Mark Ashraf",role:""},
    {name:"Ahmed Ashraf",role:""},{name:"Awad Wagdy",role:""},
    {name:"Yousef Ramdan",role:""},{name:"Ibrahim Khaled",role:""},
    {name:"Abdelrahman Ahmed",role:""},{name:"Mohamed Salem",role:"SV"},
    {name:"Yousef Ahmed Eliwa",role:"SV"},{name:"Amr Essam",role:"SV"},
    {name:"Shehab Ayman",role:"SV"},{name:"Eslam Salah",role:"SV"}
  ],
  "Over Night": [
    {name:"Omar Sharawy",role:"QT"},{name:"Mohamed Fahmy",role:"QT"},
    {name:"Hesham Nasser",role:"QT"},{name:"Ahmed Selim",role:"QT"},
    {name:"Islam Yasser",role:"QT"},{name:"El Noby",role:""},
    {name:"Ahmed Nagia",role:""},{name:"Abdalla Barbary",role:""},
    {name:"Mohamed Zakaria",role:""},{name:"Samer Neseim",role:""},
    {name:"Mohamed Ibrahim",role:""},{name:"Eyad Mohamed",role:""},
    {name:"Seif Waled",role:""},{name:"Bahi Hussien",role:""},
    {name:"Mohamed Nasr",role:""},{name:"Shreif Hossam",role:""},
    {name:"Mohamed Emam",role:""},{name:"Mahmoud Khaled Hussien",role:""},
    {name:"Karim Gaber",role:""},{name:"Yousef Fathy",role:""},
    {name:"Yousef Mohamed Saad",role:""},{name:"Ahmed Alsheikh",role:""},
    {name:"Mohamed Fathy",role:""},{name:"Yousef Ashraf Shaaban",role:""},
    {name:"Ahmed Sobhy",role:""},{name:"Hossam Taha",role:""},
    {name:"Shehab Alaa",role:""},{name:"Yousef Saber",role:""},
    {name:"Eslam Khaled",role:"SV"},{name:"Mahmoud Mohamed Mousa",role:"SV"},
    {name:"ATITO",role:"SV"}
  ]
};

function toast(msg,type){var t=document.getElementById("toast");t.textContent=msg;t.className="toast "+(type||"ok")+" show";setTimeout(function(){t.className="toast";},4200);}
function me(id){var el=document.getElementById(id);if(el)el.classList.add("err-field");}
function ce(id){var el=document.getElementById(id);if(el)el.classList.remove("err-field");}

function getN(){try{return JSON.parse(localStorage.getItem(NK))||[];}catch(e){return[];}}
function saveN(n){if(!n.trim())return;var a=getN();if(a.indexOf(n)===-1){a.unshift(n);localStorage.setItem(NK,JSON.stringify(a.slice(0,60)));}}
function delN(n){localStorage.setItem(NK,JSON.stringify(getN().filter(function(x){return x!==n;})));}
function getYK(){try{return JSON.parse(localStorage.getItem(NK_YK))||[];}catch(e){return[];}}
function saveYK(v){if(!v.trim())return;var a=getYK();if(a.indexOf(v)===-1){a.unshift(v);localStorage.setItem(NK_YK,JSON.stringify(a.slice(0,20)));}}
function delYK(v){localStorage.setItem(NK_YK,JSON.stringify(getYK().filter(function(x){return x!==v;})));}

function tick(){
  var d=new Date();
  var el=document.getElementById("ts");
  if(el)el.value=d.toLocaleString("en-US",{month:"2-digit",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:true});
  var top=document.getElementById("topTime");
  if(top)top.textContent=d.toLocaleString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:true});
}
tick(); setInterval(tick,1000);

function updateProgress(){
  var fields=["shift","unit","pcNo","labName","yk","modality","taskLink","taskId","pass","qtcName","action"];
  var filled=fields.filter(function(id){var el=document.getElementById(id);return el&&el.value&&el.value.trim();}).length;
  document.getElementById("progressBar").style.width=Math.round(filled/fields.length*100)+"%";
}
document.querySelectorAll("input,select,textarea").forEach(function(el){
  el.addEventListener("input",updateProgress);el.addEventListener("change",updateProgress);
});

document.getElementById("pcNo").addEventListener("input",function(){
  var v=this.value.trim();
  if(!v){this.style.borderColor="";return;}
  if(/^qtc$/i.test(v)){this.value="QTC";this.style.borderColor="#1a8a5a";return;}
  if(/^\d+$/.test(v)){
    var num=parseInt(v,10);
    if(num>=1&&num<=100){this.style.borderColor="#1a8a5a";}
    else{this.style.borderColor="var(--error)";}
  }else{this.style.borderColor="var(--error)";}
});

function makeSearchableDropdown(opts) {
  var btn=document.getElementById(opts.btnId),inp=document.getElementById(opts.inputId),
      list=document.getElementById(opts.listId),hidden=document.getElementById(opts.hiddenId),
      dispEl=opts.displayId?document.getElementById(opts.displayId):null,
      allItems=Array.from(list.querySelectorAll("li[data-v]")),activeIdx=-1,selectedVal="";

  function open(){btn.classList.add("open");list.classList.add("open");if(dispEl){dispEl.style.display="none";}inp.style.display="";inp.value="";filterItems("");activeIdx=-1;setTimeout(function(){inp.focus();},0);}
  function close(){btn.classList.remove("open");list.classList.remove("open");if(!hidden.value){inp.value="";inp.style.display="";if(dispEl){dispEl.innerHTML="";dispEl.style.display="none";}}else{if(dispEl){var found=allItems.find(function(li){return li.dataset.v===hidden.value;});if(found){dispEl.innerHTML=found.innerHTML;dispEl.style.display="block";}inp.style.display="none";}else{inp.value=hidden.value;}}activeIdx=-1;}
  function filterItems(q){var count=0;allItems.forEach(function(li){var text=(li.dataset.v+" "+li.textContent).toLowerCase();var match=!q||text.indexOf(q.toLowerCase())>-1;li.style.display=match?"":"none";if(match)count++;});var empty=list.querySelector(".sd-empty");if(empty)empty.remove();if(count===0){var em=document.createElement("li");em.className="sd-empty";em.textContent="No results found";list.appendChild(em);}activeIdx=-1;updateHover();}
  function updateHover(){var visible=allItems.filter(function(li){return li.style.display!=="none";});visible.forEach(function(li,i){li.classList.toggle("sd-hover",i===activeIdx);});}
  function selectItem(li){selectedVal=li.dataset.v;hidden.value=selectedVal;allItems.forEach(function(x){x.classList.remove("sel");});li.classList.add("sel");btn.style.borderColor="#1a8a5a";if(dispEl){dispEl.innerHTML=li.innerHTML;dispEl.style.display="block";inp.style.display="none";inp.value=selectedVal;}else{inp.value=selectedVal;}btn.classList.remove("open");list.classList.remove("open");activeIdx=-1;updateProgress();if(opts.onSelect)opts.onSelect(selectedVal);}

  btn.addEventListener("mousedown",function(e){if(e.target===inp)return;e.preventDefault();if(list.classList.contains("open")){close();}else{open();}});
  if(dispEl){dispEl.addEventListener("mousedown",function(e){e.preventDefault();open();});dispEl.style.cursor="pointer";}
  inp.addEventListener("focus",function(){if(!list.classList.contains("open"))open();});
  inp.addEventListener("input",function(){filterItems(this.value);hidden.value="";btn.style.borderColor="";selectedVal="";if(dispEl){dispEl.innerHTML="";dispEl.style.display="none";}});
  inp.addEventListener("blur",function(){setTimeout(close,160);});
  inp.addEventListener("keydown",function(e){var visible=allItems.filter(function(li){return li.style.display!=="none";});if(e.key==="ArrowDown"){e.preventDefault();activeIdx=Math.min(activeIdx+1,visible.length-1);updateHover();if(visible[activeIdx])visible[activeIdx].scrollIntoView({block:"nearest"});}else if(e.key==="ArrowUp"){e.preventDefault();activeIdx=Math.max(activeIdx-1,0);updateHover();if(visible[activeIdx])visible[activeIdx].scrollIntoView({block:"nearest"});}else if(e.key==="Enter"){e.preventDefault();if(activeIdx>=0&&visible[activeIdx])selectItem(visible[activeIdx]);}else if(e.key==="Escape"){close();}});
  allItems.forEach(function(li){li.addEventListener("mousedown",function(e){e.preventDefault();selectItem(li);});});

  return{reset:function(){hidden.value="";inp.value="";inp.style.display="";selectedVal="";btn.style.borderColor="";allItems.forEach(function(x){x.classList.remove("sel");});if(dispEl){dispEl.innerHTML="";dispEl.style.display="none";}filterItems("");},setValue:function(val){var li=allItems.find(function(x){return x.dataset.v===val;});if(li)selectItem(li);},getValue:function(){return hidden.value;}};
}

var shiftDD=makeSearchableDropdown({btnId:"shiftBtn",inputId:"shiftInput",listId:"shiftList",hiddenId:"shift"});
var unitDD=makeSearchableDropdown({btnId:"unitBtn",inputId:"unitInput",listId:"unitList",hiddenId:"unit"});
var qtcShiftDD=makeSearchableDropdown({btnId:"qtcShiftBtn",inputId:"qtcShiftInput",listId:"qtcShiftList",hiddenId:"qtcShiftSel",onSelect:function(val){buildQTCGrid(val);var s=document.getElementById("qtcSearch");if(s)s.value="";}});
var modalityDD=makeSearchableDropdown({btnId:"modalityBtn",inputId:"modalityInput",listId:"modalityList",hiddenId:"modality"});
var queueDD=makeSearchableDropdown({btnId:"queueBtn",inputId:"queueInput",listId:"queueList",hiddenId:"qName",displayId:"queueDisplay"});
var passDD=makeSearchableDropdown({btnId:"passBtn",inputId:"passInput",listId:"passList",hiddenId:"pass"});
var reasonDD=makeSearchableDropdown({btnId:"reasonBtn",inputId:"reasonInput",listId:"reasonList",hiddenId:"reason",onSelect:function(val){
  var sf=FRAME_R.indexOf(val)>-1,sn=(val==="Other"||val==="Edge Case");
  document.getElementById("framesRow").style.display=sf?"block":"none";
  document.getElementById("fromFrame").required=sf;
  document.getElementById("toFrame").required=sf;
  document.getElementById("notesRow").style.display=sn?"block":"none";
  document.getElementById("notes").required=(val==="Other");
  var lbl=document.getElementById("notesLabel");
  if(lbl){lbl.innerHTML=val==="Other"?'Notes <span class="req">*</span>':'Notes <span style="font-size:.72rem;color:var(--text-muted);font-weight:400">(optional)</span>';}
}});

document.addEventListener("click",function(e){["shiftBtn","unitBtn","qtcShiftBtn","modalityBtn","queueBtn","passBtn","reasonBtn"].forEach(function(id){var b=document.getElementById(id);var lid=id.replace("Btn","List");var l=document.getElementById(lid);if(b&&!b.contains(e.target)){b.classList.remove("open");if(l)l.classList.remove("open");}});});

var labIn=document.getElementById("labName"),acL=document.getElementById("acList"),acActive=-1;
function renderAC(q){var hits=q?getN().filter(function(n){return n.toLowerCase().indexOf(q.toLowerCase())>-1;}):getN();acActive=-1;if(!hits.length){acL.innerHTML="";acL.classList.remove("open");return;}acL.innerHTML="";hits.forEach(function(name){var li=document.createElement("li");var sp=document.createElement("span");sp.textContent=name;var dl=document.createElement("button");dl.className="delbtn";dl.type="button";dl.textContent="\u2715";li.appendChild(sp);li.appendChild(dl);li.addEventListener("mousedown",function(e){if(e.target===dl){e.preventDefault();delN(name);renderAC(labIn.value);if(document.getElementById("storageBody").style.display!=="none")renderStorageManager();return;}e.preventDefault();labIn.value=name;acL.classList.remove("open");acActive=-1;});acL.appendChild(li);});acL.classList.add("open");}
labIn.addEventListener("input",function(){renderAC(this.value);});
labIn.addEventListener("focus",function(){renderAC(this.value);});
labIn.addEventListener("blur",function(){setTimeout(function(){acL.classList.remove("open");acActive=-1;},180);});
labIn.addEventListener("keydown",function(e){var items=acL.querySelectorAll("li");if(!items.length)return;if(e.key==="ArrowDown"){e.preventDefault();acActive=Math.min(acActive+1,items.length-1);items.forEach(function(x,i){x.classList.toggle("ac-hover",i===acActive);});}else if(e.key==="ArrowUp"){e.preventDefault();acActive=Math.max(acActive-1,0);items.forEach(function(x,i){x.classList.toggle("ac-hover",i===acActive);});}else if(e.key==="Enter"&&acActive>=0){e.preventDefault();labIn.value=items[acActive].querySelector("span").textContent;acL.classList.remove("open");acActive=-1;}else if(e.key==="Escape"){acL.classList.remove("open");acActive=-1;}});

var ykIn=document.getElementById("yk"),ykAcL=document.getElementById("ykAcList"),ykActive=-1;
function validateYK(v){var hint=document.getElementById("ykHint");if(!v){ykIn.style.borderColor="";hint.style.color="var(--text-muted)";hint.textContent="6-digit code | or email format: ME123456@meti.ai";return;}var is6=/^\d{6}$/.test(v),isE=/^[a-zA-Z]{2}\d+@meti\.ai$/i.test(v);if(is6||isE){ykIn.style.borderColor="#1a8a5a";hint.style.color="var(--success)";hint.textContent=is6?"\u2713 Valid 6-digit code":"\u2713 Valid email";ce("yk");}else{ykIn.style.borderColor="var(--error)";hint.style.color="var(--error)";hint.textContent="Must be 6 digits or email like ME123456@meti.ai";}}
function renderYKAC(q){var hits=q?getYK().filter(function(n){return n.toLowerCase().indexOf(q.toLowerCase())>-1;}):getYK();ykActive=-1;if(!hits.length){ykAcL.innerHTML="";ykAcL.classList.remove("open");return;}ykAcL.innerHTML="";hits.forEach(function(val){var li=document.createElement("li");var sp=document.createElement("span");sp.textContent=val;var dl=document.createElement("button");dl.className="delbtn";dl.type="button";dl.textContent="\u2715";li.appendChild(sp);li.appendChild(dl);li.addEventListener("mousedown",function(e){if(e.target===dl){e.preventDefault();delYK(val);renderYKAC(ykIn.value);if(document.getElementById("storageBody").style.display!=="none")renderStorageManager();return;}e.preventDefault();ykIn.value=val;ykAcL.classList.remove("open");ykActive=-1;validateYK(val);});ykAcL.appendChild(li);});ykAcL.classList.add("open");}
ykIn.addEventListener("input",function(){validateYK(this.value.trim());renderYKAC(this.value);});
ykIn.addEventListener("focus",function(){renderYKAC(this.value);});
ykIn.addEventListener("blur",function(){setTimeout(function(){ykAcL.classList.remove("open");ykActive=-1;},180);});
ykIn.addEventListener("keydown",function(e){var items=ykAcL.querySelectorAll("li");if(!items.length)return;if(e.key==="ArrowDown"){e.preventDefault();ykActive=Math.min(ykActive+1,items.length-1);items.forEach(function(x,i){x.classList.toggle("ac-hover",i===ykActive);});}else if(e.key==="ArrowUp"){e.preventDefault();ykActive=Math.max(ykActive-1,0);items.forEach(function(x,i){x.classList.toggle("ac-hover",i===ykActive);});}else if(e.key==="Enter"&&ykActive>=0){e.preventDefault();var v=items[ykActive].querySelector("span").textContent;ykIn.value=v;ykAcL.classList.remove("open");ykActive=-1;validateYK(v);}else if(e.key==="Escape"){ykAcL.classList.remove("open");ykActive=-1;}});

function buildQTCGrid(shift){
  var grid=document.getElementById("qtcGrid"),disp=document.getElementById("qtcSelectedDisplay"),wrap=document.getElementById("qtcPickerWrap"),msg=document.getElementById("qtcShiftMsg"),hidInp=document.getElementById("qtcName");
  selectedQTC=null;hidInp.value="";disp.innerHTML="";grid.innerHTML="";
  var list=QTC_DATA[shift];
  if(!list){wrap.style.display="none";msg.style.display="block";return;}
  msg.style.display="none";wrap.style.display="block";
  list.forEach(function(p){
    var card=document.createElement("div");card.className="qtc-card";
    card.innerHTML='<div class="qtc-check"></div><div><div class="qtc-name">'+p.name+'</div>'+(p.role?'<div class="qtc-role">'+p.role+'</div>':'')+'</div>';
    card.addEventListener("click",function(){
      grid.querySelectorAll(".qtc-card.selected").forEach(function(c){c.classList.remove("selected");c.querySelector(".qtc-check").textContent="";});
      card.classList.add("selected");card.querySelector(".qtc-check").textContent="\u2713";
      selectedQTC=p.name;hidInp.value=selectedQTC;
      disp.innerHTML="";
      var tag=document.createElement("div");tag.className="qtc-tag";
      tag.innerHTML=selectedQTC+'<button type="button" title="Clear">\u2715</button>';
      tag.querySelector("button").addEventListener("click",function(){selectedQTC=null;hidInp.value="";disp.innerHTML="";card.classList.remove("selected");card.querySelector(".qtc-check").textContent="";});
      disp.appendChild(tag);
    });
    grid.appendChild(card);
  });
}
document.getElementById("qtcShiftMsg").style.display="block";
document.getElementById("qtcSearch").addEventListener("input",function(){var q=this.value.toLowerCase().trim();document.querySelectorAll("#qtcGrid .qtc-card").forEach(function(card){var name=card.querySelector(".qtc-name").textContent.toLowerCase();card.style.display=(q===""||name.indexOf(q)>-1)?"":"none";});});

document.getElementById("taskLink").addEventListener("input",function(){
  var url=this.value.trim(),P="https://labeling.robot.car/#";
  var hint=document.getElementById("linkHint"),idEl=document.getElementById("taskId"),icon=document.getElementById("idIcon");
  if(url.length>0&&!url.startsWith(P)){this.style.borderColor="var(--error)";hint.style.color="var(--error)";}
  else{this.style.borderColor=url.length>0?"#1a8a5a":"";hint.style.color="";}
  var idM=url.match(/\/id\/(\d+)/);
  if(idM){linkTaskId=idM[1];idEl.value=idM[1];idEl.style.borderColor="#1a8a5a";icon.textContent="\u2713";icon.style.color="var(--success)";icon.style.opacity="1";document.getElementById("taskIdWarn").style.display="none";}
  else{linkTaskId="";idEl.value="";idEl.style.borderColor="";icon.textContent="\u2014";icon.style.color="";icon.style.opacity=".4";document.getElementById("taskIdWarn").style.display="none";}
  var dM=url.match(/\/do\/([^\/]+)\//);
  if(dM){var pv=dM[1].toUpperCase().endsWith("QA")?"QA":"FP";passDD.setValue(pv);}else{passDD.reset();}
  updateProgress();
});

document.getElementById("taskId").addEventListener("input",function(){var warn=document.getElementById("taskIdWarn");var v=this.value.trim();if(linkTaskId&&v&&v!==linkTaskId){warn.style.display="flex";}else{warn.style.display="none";}});

function setAction(val){
  document.getElementById("action").value=val;
  var bs=document.getElementById("brSubmit"),bk=document.getElementById("brSkip"),fw=document.getElementById("finalWrap"),btn=document.getElementById("subBtn");
  document.getElementById("btnSubmit").classList.toggle("asubmit",val==="Submit");
  document.getElementById("btnSkip").classList.toggle("askip",val==="Skip");
  document.getElementById("framesRow").style.display="none";
  document.getElementById("notesRow").style.display="none";
  document.getElementById("fromFrame").required=false;
  document.getElementById("toFrame").required=false;
  document.getElementById("notes").required=false;
  reasonDD.reset();
  if(val==="Submit"){bs.style.display="block";bk.style.display="none";document.getElementById("reason").required=false;document.getElementById("objCount").required=true;btn.textContent="\u2714  Submit Task";btn.style.background="var(--success)";btn.style.boxShadow="0 3px 12px rgba(26,138,90,.3)";}
  else{bs.style.display="none";bk.style.display="block";document.getElementById("reason").required=true;document.getElementById("objCount").required=false;btn.textContent="\u23ed  Skip Task";btn.style.background="var(--primary)";btn.style.boxShadow="0 3px 12px rgba(30,108,147,.3)";}
  fw.style.display="block";
  updateProgress();
}
document.getElementById("btnSubmit").addEventListener("click",function(){setAction("Submit");});
document.getElementById("btnSkip").addEventListener("click",function(){setAction("Skip");});

document.getElementById("F").addEventListener("submit",function(e){
  e.preventDefault();
  var err=false;
  function chk(id,val){if(!val){me(id);err=true;}else ce(id);}
  function chkDD(hidId,btnId){if(!document.getElementById(hidId).value){document.getElementById(btnId).style.borderColor="var(--error)";document.getElementById(btnId).style.boxShadow="0 0 0 3px rgba(192,57,43,.1)";err=true;}else{document.getElementById(btnId).style.borderColor="";document.getElementById(btnId).style.boxShadow="";}}

  var lab=document.getElementById("labName").value.trim();
  var lnk=document.getElementById("taskLink").value.trim();
  var yk=document.getElementById("yk").value.trim();
  var act=document.getElementById("action").value;

  chkDD("shift","shiftBtn");
  chkDD("unit","unitBtn");

  var pcVal=document.getElementById("pcNo").value.trim();
  if(!pcVal){me("pcNo");err=true;}
  else if(/^qtc$/i.test(pcVal)){document.getElementById("pcNo").value="QTC";ce("pcNo");}
  else if(/^\d+$/.test(pcVal)){var pcNum=parseInt(pcVal,10);if(pcNum<1||pcNum>100){me("pcNo");err=true;toast("PC No. must be between 1 and 100","err");return;}else{ce("pcNo");}}
  else{me("pcNo");err=true;toast("PC No.: Enter a number (1100) or QTC","err");return;}

  if(!lab){me("labName");err=true;}
  else if(!/^[a-zA-Z\s]+$/.test(lab)){me("labName");err=true;toast("Labeler Name: English letters only","err");return;}
  else ce("labName");

  chkDD("qtcShiftSel","qtcShiftBtn");

  if(!document.getElementById("qtcName").value){var w=document.getElementById("qtcPickerWrap");w.style.border="1.5px solid var(--error)";w.style.borderRadius="8px";w.style.padding="8px";err=true;}
  else{var w=document.getElementById("qtcPickerWrap");w.style.border="";w.style.padding="";}

  if(!yk){me("yk");err=true;}
  else{var is6=/^\d{6}$/.test(yk),isE=/^[a-zA-Z]{2}\d+@meti\.ai$/i.test(yk);if(!is6&&!isE){me("yk");err=true;toast("Yubikey: must be 6 digits or ME123456@meti.ai","err");return;}else ce("yk");}

  chkDD("modality","modalityBtn");
  chkDD("qName","queueBtn");

  if(!lnk.startsWith("https://labeling.robot.car/#")){me("taskLink");err=true;}else ce("taskLink");
  chk("taskId",document.getElementById("taskId").value);
  chkDD("pass","passBtn");

  if(!act){document.getElementById("btnSubmit").style.borderColor="var(--error)";document.getElementById("btnSkip").style.borderColor="var(--error)";err=true;}
  else{document.getElementById("btnSubmit").style.borderColor="";document.getElementById("btnSkip").style.borderColor="";}

  if(act==="Skip"){
    chkDD("reason","reasonBtn");
    if(document.getElementById("reason").value==="Other"&&!document.getElementById("notes").value.trim()){me("notes");err=true;toast("Please write a note","err");return;}
    if(FRAME_R.indexOf(document.getElementById("reason").value)>-1){var ff=document.getElementById("fromFrame").value,tf=document.getElementById("toFrame").value;if(!ff||!tf){if(!ff)me("fromFrame");if(!tf)me("toFrame");err=true;toast("Please enter both frame numbers","err");return;}}
  }

  var obj=document.getElementById("objCount").value;
  if(act==="Submit"&&obj===""){me("objCount");err=true;toast("Please enter number of objects","err");return;}
  if(err){toast("Please fill all required fields","err");return;}

  saveN(lab);saveYK(yk);
  localStorage.setItem(NK_PC,document.getElementById("pcNo").value);

  var fromF=document.getElementById("fromFrame").value,toF=document.getElementById("toFrame").value;
  var framesVal=(fromF&&toF)?(fromF+"-"+toF):"";

  // ====== PAYLOAD -  action ======
  var payload={
    timestamp:document.getElementById("ts").value,
    shift:document.getElementById("shift").value,
    unit:document.getElementById("unit").value,
    qtcName:document.getElementById("qtcName").value,
    yubikeyEmail:yk,
    labelerName:lab,
    pcNo:document.getElementById("pcNo").value,
    modality:document.getElementById("modality").value,
    queueName:document.getElementById("qName").value,
    taskLink:lnk,
    taskId:document.getElementById("taskId").value,
    pass:document.getElementById("pass").value,
    action:act,
    objectCount:act==="Submit"?obj:"",
    reason:act==="Skip"?document.getElementById("reason").value:"",
    otherNotes:(act==="Skip"&&(document.getElementById("reason").value==="Other"||document.getElementById("reason").value==="Edge Case"))?document.getElementById("notes").value.trim():"",
    issuedFrames:act==="Skip"?framesVal:""
  };

  var btn=document.getElementById("subBtn");
  btn.disabled=true;btn.textContent="Submitting...";

  fetch(SHEET_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})
  .then(function(){
    toast("\u2713 Submitted successfully","ok");
    document.getElementById("F").reset();tick();
    selectedQTC=null;
    document.getElementById("qtcName").value="";
    document.getElementById("qtcGrid").innerHTML="";
    document.getElementById("qtcSelectedDisplay").innerHTML="";
    document.getElementById("qtcPickerWrap").style.display="none";
    document.getElementById("qtcShiftMsg").style.display="block";
    document.getElementById("qtcPickerWrap").style.border="";
    document.getElementById("qtcPickerWrap").style.padding="";
    ["brSubmit","brSkip","framesRow","notesRow","finalWrap"].forEach(function(id){document.getElementById(id).style.display="none";});
    document.getElementById("btnSubmit").classList.remove("asubmit");
    document.getElementById("btnSkip").classList.remove("askip");
    document.getElementById("action").value="";
    document.getElementById("taskId").value="";
    document.getElementById("taskId").style.borderColor="";
    document.getElementById("taskIdWarn").style.display="none";
    linkTaskId="";
    document.getElementById("idIcon").textContent="\u2014";
    document.getElementById("idIcon").style.color="";
    document.getElementById("linkHint").style.color="";
    document.getElementById("taskLink").style.borderColor="";
    shiftDD.reset();unitDD.reset();qtcShiftDD.reset();modalityDD.reset();queueDD.reset();passDD.reset();reasonDD.reset();
    ["labName","yk","pcNo","taskLink","taskId","objCount","notes","fromFrame","toFrame"]
      .forEach(function(id){var el=document.getElementById(id);if(el){el.classList.remove("err-field");el.style.borderColor="";el.style.boxShadow="";}});
    document.getElementById("progressBar").style.width="0%";
    var ykHint=document.getElementById("ykHint");
    if(ykHint){ykHint.style.color="var(--text-muted)";ykHint.textContent="6-digit code | or email format: ME123456@meti.ai";}
    document.getElementById("yk").style.borderColor="";
    ykAcL.classList.remove("open");
    btn.textContent="\u23ed  Skip Task";
    btn.style.background="var(--primary)";
    btn.disabled=false;
  })
  .catch(function(){
    toast("Submission failed. Check connection.","err");
    btn.disabled=false;
    btn.textContent=act==="Submit"?"\u2714  Submit Task":"\u23ed  Skip Task";
  });
});

document.getElementById("storageToggle").addEventListener("click",function(){
  var body=document.getElementById("storageBody"),arrow=document.getElementById("storageArrow");
  var open=body.style.display==="none";
  body.style.display=open?"block":"none";
  arrow.classList.toggle("open",open);
  if(open)renderStorageManager();
});

function renderStorageManager(){
  renderStorageGroup("storageNames",getN(),delN,function(){renderAC(labIn.value);renderStorageManager();});
  renderStorageGroup("storageYK",getYK(),delYK,function(){renderYKAC(ykIn.value);renderStorageManager();});
  var pcContainer=document.getElementById("storagePC");
  pcContainer.innerHTML="";
  var pcVal=localStorage.getItem(NK_PC);
  if(pcVal){var item=makeStorageItem(pcVal,function(){localStorage.removeItem(NK_PC);renderStorageManager();});pcContainer.appendChild(item);}
  else{var empty=document.createElement("div");empty.className="storage-empty";empty.textContent="No saved PC No.";pcContainer.appendChild(empty);}
}

function renderStorageGroup(containerId,items,delFn,afterDel){
  var container=document.getElementById(containerId);container.innerHTML="";
  if(!items.length){var empty=document.createElement("div");empty.className="storage-empty";empty.textContent="No saved items";container.appendChild(empty);return;}
  items.forEach(function(val){container.appendChild(makeStorageItem(val,function(){delFn(val);afterDel();}));});
}

function makeStorageItem(label,onDel){
  var item=document.createElement("div");item.className="storage-item";
  var txt=document.createElement("span");txt.textContent=label;
  var btn=document.createElement("button");btn.className="storage-item-del";btn.type="button";btn.textContent="\u2715";btn.title="Delete";
  btn.addEventListener("click",onDel);
  item.appendChild(txt);item.appendChild(btn);
  return item;
}

document.getElementById("clearNamesBtn").addEventListener("click",function(){localStorage.removeItem(NK);renderAC(labIn.value);renderStorageManager();});
document.getElementById("clearYKBtn").addEventListener("click",function(){localStorage.removeItem(NK_YK);renderYKAC(ykIn.value);renderStorageManager();});
document.getElementById("clearPCBtn").addEventListener("click",function(){localStorage.removeItem(NK_PC);renderStorageManager();});
</script>
</body>
</html>
